#!/bin/bash
count="1"
SAVEIFS=$IFS
IFS=$(echo -en "\n\b")
echo ""

if [[ ! -e /usr/bin/id3v2 ]] && [[ ! -e /usr/bin/mid3v2 ]]; then
	echo "ERROR: mid3v2 not installed!"
	echo "Install the package \"python-mutagen\" for Ubuntu 10.04+,"
	echo "\"mid3v2\" otherwise."
	exit 1
elif [[ -e "/usr/bin/mid3v2" ]]; then
	sanitize() {
		mid3v2 "$@"
	}
elif [[ -e "/usr/bin/id3v2" ]]; then
	sanitize() {
		/usr/bin/id3v2 "$@"
	}
fi

do_file() {
	friendlyname=${1##*/}
	echo -n "Sanitizing \"$friendlyname\"... "
	sanitize --delete-frames=POPM "$1"
	echo -e "done."
}

do_folder() {
	if [[ $(do_check_mp3) != "" ]]; then
		for f in $(ls *.mp3); do
			do_file "$f"
			count=$((count+1))
		done
		echo -e "\nSuccessfully sanitized $count MP3 files."
	else
		echo "No MP3 files in current folder."
	fi
}

do_recursive() {
	cnt=$(find ./* | grep -i '.mp3' --color=never | wc -l)
	for f in $(find ./* | grep -i '.mp3' --color=never); do
		friendlyname=${f##*/}
		echo -n "Sanitizing file $count of $cnt: \"$friendlyname\"... "
		sanitize --delete-frames=POPM "$f"
		echo -e "done."
		count=$((count+1))
	done
	echo -e "\nSuccessfully sanitized $count MP3 files."
}

if [[ $1 == "-a" ]]; then
	do_folder
elif [[ $1 == "-r" ]]; then
	do_recursive
elif [[ $1 == "-f" ]]; then
	do_file "$1"
elif [[ $1 == "-h" ]] || [[ ! $1 ]]; then
	echo -e "\nNokia Music Sanitizer"
	echo "Sanitizes MP3 files for compatibility with non-POPM"
	echo "compliant music players on phones such as the E71."

	echo -e "\nUsage:"
	echo -e "\t -a        \t Sanitize all MP3 files in current directory."
	echo -e "\t -r        \t Recursively sanitize all MP3 files in current directory."
	echo -e "\t -f <file> \t Sanitize <file>."
	echo -e "\t -h        \t Display this help message.\n"
fi

unset -v count
unset -v cnt
IFS=$SAVEIFS
exit 0
